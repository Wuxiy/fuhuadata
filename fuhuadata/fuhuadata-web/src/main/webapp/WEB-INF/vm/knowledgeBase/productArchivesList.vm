<div class="nav-deputy shadow-out clearfix">
    <ul class="breadcrumb pull-right">
        <li><span class="glyphicon glyphicon-map-marker"></span></li>
    </ul>
</div>
<!--树形导航开始-->
<div class="dashboard-wrapper">
    <div class="row">
        <div class="col-xs-2">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title" lang="zh">
                        产品分类
                    </h3>
                </div>
                <div class="panel-body tree-container clearfix">
                    <!--树形菜单-->
                    <div class="tree" id="tree">

                    </div>
                </div>
            </div>
        </div>
        <!--列表部分-->
        <div class="col-xs-10">
            <div class="panel panel-default view-HD-lg">
                <div class="panel-heading">
                    <button id="disTree" data-form-btn="edit" class="btn btn-xs btn-primary panel-heading-btn pull-right" type="button" lang="zh">
                        编辑
                    </button>
                    <div class="but-group btn-group btn-group-xs panel-heading-btn pull-right hidden">
                        <button data-form-btn="cancel" class="btn" lang="zh">取消</button>
                        <button id="productInfo" data-form-btn="save" class="btn btn-primary" lang="zh">保存</button>
                    </div>
                    <h3 class="panel-title" lang="zh">
                        标准产品档案
                    </h3>
                </div>
                <div id="container" class="panel-body panel-edit clearfix">
                    <from class="form-horizontal">
                        <div class="form-group">
                            <label class="col-xs-1 control-label">品类</label>
                            <div class="col-xs-2">
                                <input name="categoryName" class="form-control noEdit" type="text"/>
                            </div>
                            <label class="col-xs-1 control-label">品名</label>
                            <div class="col-xs-2">
                                <input name="name" class="form-control noEdit" type="text"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-xs-1 control-label">主计量单位</label>
                            <div class="col-xs-2">
                                <input name="measurementUnit" class="form-control noEdit" type="text"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-xs-1 control-label" lang="zh">规格型号</label>
                            <div class="col-xs-4">
                                <table class="table table-condensed table-bordered table-striped text-center">
                                    <thead>
                                    <tr>
                                        <th class="text-center col-xs-4" lang="zh">规格</th>
                                        <th class="text-center col-xs-4" lang="zh">型号</th>
                                    </tr>
                                    </thead>
                                    <tbody name="wares">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-xs-1 control-label">含量</label>
                            <div class="col-xs-2">
                                <div class="input-group">
                                    <input name="concentration" class="form-control" type="text"/>
                                    <span class="input-group-addon">%</span>
                                </div>
                            </div>
                            <label class="col-xs-1 control-label">盐类</label>
                            <div class="col-xs-7">
                                <label class="radio-inline"><input name="saltType" type="radio" value="0">无</label>
                                <label class="radio-inline"><input name="saltType" type="radio" value="1">异丙胺盐</label>
                                <label class="radio-inline"><input name="saltType" type="radio" value="2">铵盐</label>
                                <label class="radio-inline"><input name="saltType" type="radio" value="3">钾盐</label>
                                <label class="radio-inline"><input name="saltType" type="radio" value="4">二钾铵盐</label>
                                <label class="radio-inline" style="position: relative"><input class="else" name="saltType" type="radio" value="5">其他<input class="form-control elseInput hidden" name="otherSaltName" type="text" style="position: absolute;right: -210px;top:0;width: 200px;" placeholder="请输入其他盐类"></label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-xs-1 control-label">执行标准</label>
                            <div class="col-xs-2">
                                <select name="executeStandard" class="form-control">
                                    <option value="-1">全部</option>
                                    <option value="0">国际标准</option>
                                    <option value="1">国家标准</option>
                                    <option value="2">行业标准</option>
                                    <option value="3">福华通达企业标准</option>
                                    <option value="4">其他</option>
                                </select>
                            </div>
                            <label class="col-xs-1 control-label">执行标准号</label>
                            <div class="col-xs-2">
                                <input name="executeNumer" class="form-control" type="text"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="" class="col-xs-1 control-label" lang="zh">产品特点</label>
                            <div class="col-xs-6">
                                <textarea name="productFeature" class="form-control" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-xs-1 control-label">加工成份</label>
                            <div class="col-xs-6">
                                <table class="table table-condensed table-bordered table-striped text-center">

                                    <tbody name="processingComponents">

                                    </tbody>

                                </table>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-xs-1 control-label">理化指标</label>
                            <div class="col-xs-6">
                                <table class="table table-condensed table-bordered table-striped text-center">

                                    <tbody name="physicalProperities">

                                    </tbody>

                                </table>
                            </div>
                        </div>
                    </from>
                </div>
            </div>
        </div>
    </div>
</div>


<script type="text/javascript" language="javascript" src="${request.contextPath}/lib/js/creatTree.js"></script>
<script type="text/javascript" language="javascript" src="${request.contextPath}/lib/js/scaffolding.js"></script>
<script type="text/javascript">

(function ($) {
    $(function () {


        $('#tree').creatTree('${request.contextPath}/productCategory/CategoryTree');
        $('#tree').filtrateData('${request.contextPath}/productInfo/getProductInfoById','container','productArchivesList');
        //初始数据
        productInfoForm({id:1011001});
        //数据提交
        $(document).on('click.upData','#productInfo',upProductInfo);

        //添加row
        $(document).on('click.add','#addIndexItem',function () {
            var tr = $('<tr><td><input class="form-control" type="text" value=""></td><td><input class="form-control" type="text" value=""></td><td style="position: relative"><input class="form-control" type="text" value=""/><button type="button" class="close" data-form-btn="del" data-form-target="tr" style="position: absolute;top:6px;right:-15px;">×</button></td></tr>');
            tr.appendTo('[name="physicalProperities"]');
        });
        $(document).on('click.add','#addProItem',function () {
            var tr = $('<tr><td><input class="form-control" type="text" value=""></td><td><input class="form-control" type="text" value=""></td><td style="position: relative"><input class="form-control" type="text" value=""/><button type="button" class="close" data-form-btn="del" data-form-target="tr" style="position: absolute;top:6px;right:-15px;">×</button></td></tr>');
            tr.appendTo('[name="processingComponents"]');
        });
        $(document).on('click.del',saltType,radioChecked);

    })

    /**
     *productInfo
     */
    function productInfoForm(data) {
        jQuery.ajax({
            url:'/productInfo/getProductInfoById',
            type:'POST',
            data:data
        }).done(function(data){
            var getData = data.data;
            //表单处理
            jQuery.each(getData.productInfo,function(key,item){
                if(key!='physicalProperities'&& key!='processingComponents'){
                    var formControl=$('[name="'+ key +'"]');
                    // console.log(key);
                    if(formControl.attr('type')=='radio'||formControl.attr('type')=='checkbox'){
                        var arr=[item];
                        formControl.val(arr);
                    }else {
                        formControl.val(item);
                    }
                    if(key=='saltType'){
                        var elseSelected = formControl.filter('.else');
                        var targetEl = formControl.parents('.form-group').find('.elseInput');
                        if(elseSelected.prop('checked')){
                            console.log(formControl.prop('checked'));
                            targetEl.removeClass('hidden');
                        }else{
                            targetEl.addClass('hidden');
                        }
                    }
                }
            });
            //表格处理
            var wTbody = $('[name="wares"]');
            var iTbody = $('[name="physicalProperities"]');
            var pTbody = $('[name="processingComponents"]');
            var iThead = $('<thead><tr><th class="text-center col-xs-4" lang="zh">指标</th><th class="text-center col-xs-4" lang="zh">值</th><th class="text-center col-xs-4" lang="zh">备注</th></tr></thead>');
            var iTfoot = $('<tfoot class="editView hidden"><tr><td colspan="3"><button id="addIndexItem" data-form-btn="add" class="btn btn-xs btn-link hidden" type="button" lang="zh">继续添加</button></td></tr></tfoot>');
            var pThead = $('<thead><tr><th class="text-center col-xs-4" lang="zh">原料</th><th class="text-center col-xs-4" lang="zh">单耗（kg/KL）</th><th class="text-center col-xs-4" lang="zh">备注</th></tr></thead>');
            var pTfoot = $('<tfoot class="editView hidden"><tr><td colspan="3"><button id="addProItem" data-form-btn="add" class="btn btn-xs btn-link hidden" type="button" lang="zh">继续添加</button></td></tr></tfoot>');

            wTbody.add(iTbody).add(pTbody).html('');
            if(getData.productInfo.midCategoryId==8){
                var textIndex = getData.productInfo.physicalProperities;
                var textProcessingComponents = getData.productInfo.processingComponents;
                var iTextarea = $('<tr><td colspan="3"><textarea class="form-control" rows="3" disabled></textarea></td></tr>');
                var pTextarea = $('<tr><td colspan="3"><textarea class="form-control" rows="3" disabled></textarea></td></tr>');
                iTextarea.find('textarea').val(textIndex).end().appendTo(iTbody);
                pTextarea.find('textarea').val(textProcessingComponents).end().appendTo(pTbody);
                iTfoot.add(iThead).add(pThead).add(pTfoot).remove();
            }else{
                if(getData.wares!=null){
                    jQuery.each(getData.wares,function(key,item){
                        var tr = $("<tr></tr>");
                        tr.append('<td>'+item.specification+'</td><td>'+item.model+'</td>').appendTo(wTbody);
                    });
                }
                if(getData.index!=null){
                    jQuery.each(getData.index,function(key,item){
                        var tr = $("<tr></tr>");
                        tr.append('<td><input class="form-control" type="text" disabled value="'+item.index+'"></td><td><input class="form-control" type="text" disabled value="'+item.value+'"></td><td style="position: relative"><input class="form-control" type="text" disabled value="'+item.remarks+'"/><button type="button" class="close hidden" data-form-btn="del" data-form-target="tr" style="position: absolute;top:6px;right:-15px;">×</button></td>').appendTo(iTbody);
                    });
                }
                if(getData.processingComponents!=null){
                    jQuery.each(getData.processingComponents,function(key,item){
                        var tr = $("<tr></tr>");
                        tr.append('<td><input class="form-control" type="text" disabled value="'+item.componentName+'"></td><td><input class="form-control" type="text" disabled value="'+item.consumption+'"></td><td style="position: relative"><input class="form-control" type="text" disabled value="'+item.remarks+'"/><button type="button" class="close hidden" data-form-btn="del" data-form-target="tr" style="position: absolute;top:6px;right:-15px;">×</button></td>').appendTo(pTbody);
                    });

                }
                iThead.insertBefore(iTbody);
                iTfoot.insertAfter(iTbody);
                pThead.insertBefore(pTbody);
                pTfoot.insertAfter(pTbody);
            }
        });
    }

    /**
     * productInfo up data
     */
   function upProductInfo(e){
        e.stopPropagation();
        var content = $('#container');
        var upData = {
            'productFeature': content.find('[name="productFeature"]').val(),
            'modifyTime': getTime(),
            'productId': $('a:contains('+content.find('[name="name"]').val()+')').parent('li').attr('id'),
            'saltType': content.find('[name="saltType"]:checked').val(),//传0
            'otherSaltName':content.find('[name="otherSaltName"]').val(),
            'executeNumer' : content.find('[name="executeNumer"]').val(),
            'physicalProperities' : getPPTable(),
            'processingComponents' : getPCTable(),
            'executeStandard' : content.find('[name="executeStandard"]').val()
        };
        console.log(upData);
        function getPPTable() {
            var p = content.find('[name="physicalProperities"]').find('tr');
            console.log(p.find('textarea').length);
            if(p.find('textarea').length!=1){
                var arr = [];
                p.each(function(){
                    var obj = {};
                    $(this).find('td').each(function(n,td){
                        if(n==0){
                            obj.index = $(td).children('input').val();
                        }else if (n==1){
                            obj.value = $(td).children('input').val();
                        }else {
                            obj.remarks = $(td).children('input').val();
                        }
                    });
                    arr.push(obj);
                })
                return JSON.stringify(arr);
            }else{
                return p.find('textarea').val();
            }
        };
        function getPCTable() {
            var p = content.find('[name="processingComponents"]').find('tr');
            if(p.find('textarea').length!=1){
                var arr = [];
                p.each(function(){
                    var obj = {};
                    $(this).find('td').each(function(n,td){
                        if(n==0){
                            obj.componentName = $(td).children('input').val();
                        }else if (n==1){
                            obj.consumption = $(td).children('input').val();
                        }else {
                            obj.remarks = $(td).children('input').val();
                        }
                    });
                    arr.push(obj);
                })
                return JSON.stringify(arr);
            }else{
                return p.find('textarea').val();
            }
        };
        function getTime(){
            var time = new Date();
            var year = time.getFullYear();
            var month = parseInt(time.getMonth())+1;
            var day = time.getDate();
            var hours = parseInt(time.getHours());
            var minutes = parseInt(time.getMinutes());
            var seconds = parseInt(time.getSeconds());
            var newTime;
            return newTime = year+'-'+month+'-'+day+' '+hours+':'+minutes+':'+seconds;
        };
        jQuery.ajax({
            'url':${request.contextPath}'/productInfo/doModify',
            'type':'post',
            'data':JSON.stringify(upData),
            'contentType':"application/json"
        }).done(function(){
            alert('保存成功');
        });
    }

    })(jQuery);
</script>
