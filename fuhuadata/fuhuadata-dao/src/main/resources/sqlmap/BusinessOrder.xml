<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN"
        "http://www.ibatis.com/dtd/sql-map-2.dtd">
<sqlMap namespace="BUSINESSORDER">
    <typeAlias alias="BusinessOrder" type="com.fuhuadata.domain.BusinessOrder"/>
    <typeAlias alias="QueryBusinessOrder" type="com.fuhuadata.domain.query.QueryBusinessOrder"/>
    <typeAlias alias="CostAndProfitStatistics" type="com.fuhuadata.vo.CostAndProfitStatistics"/>

    <resultMap id="BUSINESSORDER-MAP" class="BusinessOrder">
        <result column="order_id" jdbcType="VARCHAR" property="orderId" javaType="java.lang.String"/>
        <result column="nc_order_id" jdbcType="VARCHAR" property="ncOrderId" javaType="java.lang.String"/>
        <result column="business_id" jdbcType="VARCHAR" property="businessId" javaType="java.lang.String"/>
        <result column="customer_id" jdbcType="INTEGER" property="customerId" javaType="java.lang.String"/>
        <result column="customer_duty_paragraph" jdbcType="VARCHAR" property="customerDutyParagraph" javaType="java.lang.String"/>
        <result column="bill_to_customer" jdbcType="VARCHAR" property="billToCustomer" javaType="java.lang.String"/>
        <result column="sales_man_id" jdbcType="VARCHAR" property="salesManId" javaType="java.lang.String"/>
        <result column="sales_man_name" jdbcType="VARCHAR" property="salesManName" javaType="java.lang.String"/>
        <result column="department_id" jdbcType="VARCHAR" property="departmentId" javaType="java.lang.String"/>
        <result property="departmentName" column="department_name" jdbcType="VARCHAR" javaType="java.lang.String"/>
        <result column="sale_organization_id" jdbcType="VARCHAR" property="saleOrganizationId" javaType="java.lang.String"/>
        <result column="sale_organization_name" jdbcType="VARCHAR" property="saleOrganizationName" javaType="java.lang.String"/>
        <result column="destination_port" jdbcType="VARCHAR" property="destinationPort" javaType="java.lang.String"/>
        <result column="shipment_port" jdbcType="VARCHAR" property="shipmentPort" javaType="java.lang.String"/>
        <result column="collection_agreement" jdbcType="VARCHAR" property="collectionAgreement" javaType="java.lang.String"/>
        <result column="trade_type" jdbcType="TINYINT" property="tradeType" javaType="java.lang.Integer"/>
        <result column="trade_term" jdbcType="VARCHAR" property="tradeTerm" javaType="java.lang.String"/>
        <result column="currency" jdbcType="VARCHAR" property="currency" javaType="java.lang.String"/>

        <result property="isCreditRisk" column="is_credit_risk" jdbcType="INT" javaType="java.lang.Integer"/>
        <result property="interestRate" column="interest_rate" jdbcType="DECIMAL" javaType="java.math.BigDecimal"/>


        <result column="nusdexchgrate" jdbcType="DECIMAL" property="nusdexchgrate" javaType="java.math.BigDecimal"/>
        <result column="nexchangerate" jdbcType="DECIMAL" property="nexchangerate" javaType="java.math.BigDecimal"/>
        <result column="lastdelydate" jdbcType="TIMESTAMP" property="lastdelydate" javaType="java.sql.Timestamp"/>

        <result column="trade_country" jdbcType="VARCHAR" property="tradeCountry" javaType="java.lang.String"/>
        <result column="premium_rate" jdbcType="DECIMAL" property="premiumRate" javaType="java.math.BigDecimal"/>
        <result column="guarantee_rate" jdbcType="DECIMAL" property="guaranteeRate" javaType="java.math.BigDecimal"/>
        <result column="discount_rate" jdbcType="DECIMAL" property="discountRate" javaType="java.math.BigDecimal"/>
        <result column="loss_rate" jdbcType="DECIMAL" property="lossRate" javaType="java.math.BigDecimal"/>
        <result column="sale_rate" jdbcType="DECIMAL" property="saleRate" javaType="java.math.BigDecimal"/>
        <result column="management_rate" jdbcType="DECIMAL" property="managementRate" javaType="java.math.BigDecimal"/>
        <result column="gross_rate" jdbcType="DECIMAL" property="grossRate" javaType="java.math.BigDecimal"/>
        <result column="credit_rate" jdbcType="DECIMAL" property="creditRate" javaType="java.math.BigDecimal"/>
        <result column="transport_flag" jdbcType="TINYINT" property="transportFlag" javaType="java.lang.Integer"/>
        <result column="partial_shipment_falg" jdbcType="TINYINT" property="partialShipmentFalg" javaType="java.lang.Integer"/>
        <result column="status" jdbcType="TINYINT" property="status" javaType="java.lang.Integer"/>
        <result column="deal_time" jdbcType="TIMESTAMP" property="dealTime" javaType="java.sql.Timestamp"/>
        <result column="deliver_info" jdbcType="VARCHAR" property="deliverInfo" javaType="java.lang.String"/>
        <result column="express_info" jdbcType="VARCHAR" property="expressInfo" javaType="java.lang.String"/>
        <result column="due_time" jdbcType="DATE" property="dueTime" javaType="java.lang.String"/>

        <result column="amount_payable" jdbcType="DECIMAL" property="amountPayable" javaType="java.math.BigDecimal"/>
        <result column="floor_price" jdbcType="DECIMAL" property="floorPrice" javaType="java.math.BigDecimal"/>

        <result column="maintenance_fee" jdbcType="DECIMAL" property="maintenanceFee" javaType="java.math.BigDecimal"/>
        <result column="net_profit" jdbcType="DECIMAL" property="netProfit" javaType="java.math.BigDecimal"/>
        <result column="actual_payment_time" jdbcType="DATE" property="actualPaymentTime" javaType="java.sql.Date"/>
        <result column="gross_profit" jdbcType="DECIMAL" property="grossProfit" javaType="java.math.BigDecimal"/>
        <result column="actual_amount_paid" jdbcType="DECIMAL" property="actualAmountPaid" javaType="java.math.BigDecimal" />
        <result column="unpaid_amount" jdbcType="DECIMAL" property="unpaidAmount" javaType="java.math.BigDecimal"/>
        <result column="is_complaint" jdbcType="TINYINT" property="isComplaint" javaType="java.lang.Integer"/>
        <result column="is_pledge" jdbcType="TINYINT" property="isPledge" javaType="java.lang.Integer"/>
        <result column="is_modify_price" jdbcType="TINYINT" property="isModifyPrice" javaType="java.lang.Integer"/>
        <result column="claim_amount" jdbcType="DECIMAL" property="claimAmount" javaType="java.math.BigDecimal"/>
        <result column="create_user_id" jdbcType="INTEGER" property="createUserId" javaType="java.lang.Integer"/>
        <result column="create_user_name" jdbcType="VARCHAR" property="createUserName" javaType="java.lang.String"/>
        <result column="lastmodify_user_id" jdbcType="INTEGER" property="lastmodifyUserId" javaType="java.lang.Integer"/>
        <result column="lastmodify_user_name" jdbcType="VARCHAR" property="lastmodifyUserName" javaType="java.lang.String"/>
        <result column="create_time" jdbcType="TIMESTAMP" property="createTime" javaType="java.lang.String"/>
        <result column="modify_time" jdbcType="TIMESTAMP" property="modifyTime" javaType="java.lang.String"/>
        <result column="failure_analysis" jdbcType="VARCHAR" property="failureAnalysis" javaType="java.lang.String"/>
    </resultMap>


    <sql id="COST-PROFIT-QUERY-COMMON">
        <dynamic prepend=" WHERE ">
            <isNotEmpty prepend=" AND " property="customerName">
                base.full_name like concat('%',#customerName#,'%')
            </isNotEmpty>
            <isNotEmpty prepend=" AND " property="customerLevel">
                base.customer_level = #customerLevel#
            </isNotEmpty>
            <isNotEmpty prepend=" AND " property="country">
                base.country = #country#
            </isNotEmpty>
            <isNotEmpty prepend=" AND " property="startTime">
                <![CDATA[
                     a.deal_time  >=  #startTime#
                ]]>
            </isNotEmpty>
            <isNotEmpty prepend=" AND " property="endTime">
                <![CDATA[
                     a.deal_time  <=  #endTime#
                ]]>
            </isNotEmpty>
            <isNotEmpty prepend=" AND " property="salesManId">
                a.sales_man_id = #salesManId#
            </isNotEmpty>
            <isNotEqual property="areaClassId" compareValue="0" prepend=" AND ">
                base.customer_area_id = #areaClassId#
                <isNotEqual property="areaId" compareValue="0" prepend=" AND ">
                    base.country_id = #areaId#
                </isNotEqual>
            </isNotEqual>
        </dynamic>
    </sql>


    <sql id="QUERY-COMMON">
        <dynamic prepend=" WHERE ">
            <isNotEmpty prepend=" AND " property="customerId">
                customer_id = #customerId#
            </isNotEmpty>
            <isNotEmpty prepend=" AND " property="status">
                status = #status#
            </isNotEmpty>
            <isNotEmpty prepend=" AND " property="saleOrganizationId">
                sale_organization_id = #saleOrganizationId#
            </isNotEmpty>
            <isNotEmpty prepend=" AND " property="ncOrderId">
                nc_order_id =  #ncOrderId#
            </isNotEmpty>
            <isNotEmpty prepend=" AND " property="startTime">
                <![CDATA[
                     deal_time  >=  #startTime#
                ]]>
            </isNotEmpty>
        </dynamic>
    </sql>

    <sql id="ORDER-PAGE-COMMON">
        <dynamic prepend=" WHERE ">
            <isNotEmpty prepend=" AND " property="customerId">
                base.short_name like concat('%',#customerName#,'%')
            </isNotEmpty>
            <isNotEmpty prepend=" AND " property="salesManId">
                a.sales_man_id = #salesManId#
            </isNotEmpty>
            <isNotEmpty prepend=" AND " property="ncOrderId">
                a.nc_order_id like concat('%',#ncOrderId#,'%')
            </isNotEmpty>
            <isNotEmpty prepend=" AND " property="status">
                a.status = #status#
            </isNotEmpty>
            <isNotEmpty prepend=" AND " property="saleOrganizationId">
                sale_organization_id = #saleOrganizationId#
            </isNotEmpty>
            <isNotEmpty prepend=" AND " property="customerLevel">
                base.customer_level = #customerLevel#
            </isNotEmpty>
            <isNotEqual property="areaClassId" compareValue="0" prepend=" AND ">
                 base.customer_area_id = #areaClassId#
                <isNotEqual property="areaId" compareValue="0" prepend=" AND ">
                    base.country_id = #areaId#
                </isNotEqual>
            </isNotEqual>
            <isNotEmpty prepend=" AND " property="enterpriseNature">
                nature.customer_id=base.customer_id
            </isNotEmpty>
            <isNotNull prepend=" AND ">
                a.`status` IN (-1,2,3)
            </isNotNull>
            <isNotEmpty prepend=" AND " property="orderBy">
                order by $orderBy$
            </isNotEmpty>
            <isNotEmpty prepend=" AND " property="startTime">
                <![CDATA[
                     deal_time  >=  #startTime#
                ]]>
            </isNotEmpty>
            <isNotEmpty prepend=" AND " property="endTime">
                <![CDATA[
                     deal_time  <=  #endTime#
                ]]>
            </isNotEmpty>

        </dynamic>
    </sql>

    <sql id="OFFER-PAGE-COMMON">
        <dynamic prepend=" WHERE">
            <isNotEmpty prepend=" AND " property="customerName">
                base.short_name = #customerName#
            </isNotEmpty>
            <isNotEmpty prepend=" AND " property="status">
                a.status = #status#
            </isNotEmpty>
            <isNotEmpty prepend=" AND " property="orderId">
                a.order_id = #orderId#
            </isNotEmpty>
            <isNotEmpty prepend=" AND " property="customerLevel">
                base.customer_level = #customerLevel#
            </isNotEmpty>
            <isNotEqual property="areaClassId" compareValue="0" prepend=" AND ">
                base.customer_area_id = #areaClassId#
                <isNotEqual property="areaId" compareValue="0" prepend=" AND ">
                    base.country_id = #areaId#
                </isNotEqual>
            </isNotEqual>
            <isNotEmpty prepend=" AND " property="enterpriseNature">
                nature.customer_id=base.customer_id
            </isNotEmpty>
            <isNotNull prepend=" AND ">
                a.`status` IN (-2,0,1)
            </isNotNull>
            <isNotEmpty prepend=" AND " property="orderBy">
                order by $orderBy$
            </isNotEmpty>
        </dynamic>
    </sql>

    <update id="UPDATE" parameterClass="BusinessOrder" >
        update business_order
        <dynamic prepend="set" >
            <isNotNull prepend=", " property="isCreditRisk">
                is_credit_risk = #isCreditRisk#
            </isNotNull>
            <isNotNull prepend=", " property="interestRate">
                interest_rate = #interestRate#
            </isNotNull>
            <isNotNull prepend=", " property="departmentName">
                department_name = #departmentName#
            </isNotNull>
            <isNotNull prepend=", " property="nusdexchgrate">
                nusdexchgrate = #nusdexchgrate#
            </isNotNull>
            <isNotNull prepend=", " property="nexchangerate">
                nexchangerate = #nexchangerate#
            </isNotNull>
            <isNotNull prepend=", " property="lastdelydate">
                lastdelydate = #lastdelydate#
            </isNotNull>
            <isNotNull prepend=", " property="grossProfit">
                gross_profit= #grossProfit#
            </isNotNull>


            <isNotNull prepend=", " property="ncOrderId" >
                nc_order_id = #ncOrderId#
            </isNotNull>
            <isNotNull prepend=", " property="businessId" >
                business_id = #businessId#
            </isNotNull>
            <isNotNull prepend=", " property="customerId" >
                customer_id = #customerId#
            </isNotNull>
            <isNotNull prepend=", " property="customerDutyParagraph" >
                customer_duty_paragraph = #customerDutyParagraph#
            </isNotNull>
            <isNotNull prepend=", " property="billToCustomer" >
                bill_to_customer = #billToCustomer#
            </isNotNull>
            <isNotNull prepend=", " property="salesManId" >
                sales_man_id = #salesManId#
            </isNotNull>
            <isNotNull prepend=", " property="salesManName" >
                sales_man_name = #salesManName#
            </isNotNull>
            <isNotNull prepend=", " property="departmentId" >
                department_id = #departmentId#
            </isNotNull>
            <isNotNull prepend=", " property="saleOrganizationId" >
                sale_organization_id = #saleOrganizationId#
            </isNotNull>
            <isNotNull prepend=", " property="saleOrganizationName" >
                sale_organization_name = #saleOrganizationName#
            </isNotNull>
            <isNotNull prepend=", " property="destinationPort" >
                destination_port = #destinationPort#
            </isNotNull>
            <isNotNull prepend=", " property="shipmentPort" >
                shipment_port = #shipmentPort#
            </isNotNull>
            <isNotNull prepend=", " property="collectionAgreement" >
                collection_agreement = #collectionAgreement#
            </isNotNull>
            <isNotNull prepend=", " property="tradeType" >
                trade_type = #tradeType#
            </isNotNull>
            <isNotNull prepend=", " property="tradeTerm" >
                trade_term = #tradeTerm#
            </isNotNull>
            <isNotNull prepend=", " property="currency" >
                currency = #currency#
            </isNotNull>
            <isNotNull prepend=", " property="tradeCountry" >
                trade_country = #tradeCountry#
            </isNotNull>
            <isNotNull prepend=", " property="premiumRate" >
                premium_rate = #premiumRate#
            </isNotNull>
            <isNotNull prepend=", " property="guaranteeRate" >
                guarantee_rate = #guaranteeRate#
            </isNotNull>
            <isNotNull prepend=", " property="discountRate" >
                discount_rate = #discountRate#
            </isNotNull>
            <isNotNull prepend=", " property="lossRate" >
                loss_rate = #lossRate#
            </isNotNull>
            <isNotNull prepend=", " property="saleRate" >
                sale_rate = #saleRate#
            </isNotNull>
            <isNotNull prepend=", " property="managementRate" >
                management_rate = #managementRate#
            </isNotNull>
            <isNotNull prepend=", " property="grossRate" >
                gross_rate = #grossRate#
            </isNotNull>
            <isNotNull prepend=", " property="creditRate" >
                credit_rate = #creditRate#
            </isNotNull>
            <isNotNull prepend=", " property="transportFlag" >
                transport_flag = #transportFlag#
            </isNotNull>
            <isNotNull prepend=", " property="partialShipmentFalg" >
                partial_shipment_falg = #partialShipmentFalg#
            </isNotNull>
            <isNotNull prepend=", " property="status" >
                status = #status#
            </isNotNull>
            <isNotNull prepend=", " property="dealTime" >
                deal_time = #dealTime#
            </isNotNull>
            <isNotNull prepend="," property="deliverInfo" >
                deliver_info = #deliverInfo#
            </isNotNull>
            <isNotNull prepend=", " property="expressInfo" >
                express_info = #expressInfo#
            </isNotNull>
            <isNotNull prepend=", " property="dueTime" >
                due_time = #dueTime#
            </isNotNull>
            <isNotNull prepend=", " property="amountPayable" >
                amount_payable = #amountPayable#
            </isNotNull>
            <isNotNull prepend=", " property="floorPrice" >
                floor_price = #floorPrice#
            </isNotNull>
            <isNotNull prepend=", " property="maintenanceFee" >
                maintenance_fee = #maintenanceFee#
            </isNotNull>
            <isNotNull prepend=", " property="netProfit" >
                net_profit = #netProfit#
            </isNotNull>
            <isNotNull prepend=", " property="actualPaymentTime" >
                actual_payment_time = #actualPaymentTime#
            </isNotNull>
            <isNotNull prepend=", " property="actualAmountPaid" >
                actual_amount_paid = #actualAmountPaid#
            </isNotNull>
            <isNotNull prepend=", " property="unpaidAmount" >
                unpaid_amount = #unpaidAmount#
            </isNotNull>
            <isNotNull prepend="," property="isComplaint" >
                is_complaint = #isComplaint#
            </isNotNull>
            <isNotNull prepend="," property="isPledge" >
                is_pledge = #isPledge#
            </isNotNull>
            <isNotNull prepend="," property="isModifyPrice" >
                is_modify_price = #isModifyPrice#
            </isNotNull>
            <isNotNull prepend="," property="claimAmount" >
                claim_amount = #claimAmount#
            </isNotNull>
            <isNotNull prepend="," property="createUserId" >
                create_user_id = #createUserId#
            </isNotNull>
            <isNotNull prepend="," property="createUserName" >
                create_user_name = #createUserName#
            </isNotNull>
            <isNotNull prepend="," property="lastmodifyUserId" >
                lastmodify_user_id = #lastmodifyUserId#
            </isNotNull>
            <isNotNull prepend="," property="lastmodifyUserName" >
                lastmodify_user_name = #lastmodifyUserName#
            </isNotNull>
            <isNotNull prepend="," property="createTime" >
                create_time = #createTime#
            </isNotNull>
            <isNotNull prepend="," property="modifyTime" >
                modify_time = #modifyTime#
            </isNotNull>
        </dynamic>
        where order_id = #orderId#
    </update>
    <insert id="ADD" parameterClass="BusinessOrder" >

        insert into business_order (order_id, nc_order_id, business_id, customer_id,
        customer_duty_paragraph, bill_to_customer, sales_man_id, sales_man_name, department_id,
        sale_organization_id, sale_organization_name, destination_port, shipment_port,
        collection_agreement, trade_type, trade_term, currency, trade_country, premium_rate,
        guarantee_rate, discount_rate, loss_rate, sale_rate, management_rate, gross_rate, credit_rate,
        transport_flag, partial_shipment_falg, status, deal_time, deliver_info, express_info, due_time,
        amount_payable, floor_price, maintenance_fee, net_profit, actual_payment_time,
        actual_amount_paid, unpaid_amount, is_complaint, is_pledge, is_modify_price, claim_amount,
        create_user_id, create_user_name, lastmodify_user_id, lastmodify_user_name, create_time,
        modify_time,gross_profit,is_credit_risk,interest_rate,department_name,nusdexchgrate,nexchangerate,lastdelydate,gross_profit)
        values (#orderId#, #ncOrderId#, #businessId#, #customerId#,
        #customerDutyParagraph#, #billToCustomer#, #salesManId#,
        #salesManName#, #departmentId#, #saleOrganizationId#,
        #saleOrganizationName#, #destinationPort#, #shipmentPort#,
        #collectionAgreement#, #tradeType#, #tradeTerm#, #currency#,
        #tradeCountry#, #premiumRate#, #guaranteeRate#,
        #discountRate#, #lossRate#, #saleRate#, #managementRate#,
        #grossRate#, #creditRate#, #transportFlag#,
        #partialShipmentFalg#, #status#, #dealTime#, #deliverInfo#,
        #expressInfo#, #dueTime#, #amountPayable#, #floorPrice#,
        #maintenanceFee#, #netProfit#, #actualPaymentTime#,
        #actualAmountPaid#, #unpaidAmount#, #isComplaint#, #isPledge#,
        #isModifyPrice#, #claimAmount#, #createUserId#,
        #createUserName#, #lastmodifyUserId#, #lastmodifyUserName#,
        #createTime#, #modifyTime#, #isCreditRisk#,#interestRate#,#departmentName#,#nusdexchgrate#,#nexchangerate#,#lastdelydate#，#grossProfit#)

    </insert>

    <select id="GET-BY-ID" resultMap="BUSINESSORDER-MAP" parameterClass="java.lang.String" >
        <![CDATA[
        select *  from business_order
        where order_id = #orderId#
    ]]>
    </select>

    <update id="UPDATE-OFFER-STATUS" parameterClass="BusinessOrder">
        update business_order
        <dynamic prepend="set" >
            <isNotNull prepend=", " property="failureAnalysis" >
                failure_analysis = #failureAnalysis#
            </isNotNull>
            <isNotNull prepend=", " property="status" >
                status = #status#
            </isNotNull>
            <isNotNull prepend="," property="lastmodifyUserId" >
                lastmodify_user_id = #lastmodifyUserId#
            </isNotNull>
            <isNotNull prepend="," property="lastmodifyUserName" >
                lastmodify_user_name = #lastmodifyUserName#
            </isNotNull>
            <isNotNull prepend="," property="modifyTime" >
                modify_time = #modifyTime#
            </isNotNull>
        </dynamic>
        where order_id = #orderId#
    </update>

    <select id="OFFER-GET-PAGE"  parameterClass="QueryBusinessOrder" resultClass="QueryBusinessOrder">
        <![CDATA[
            SELECT
            a.order_id orderId,
            a.business_id businessId,
            base.short_name customerName,
            base.customer_level customerLevel,
            base.full_enterprise_nature enterpriseNature,
            a.amount_payable amountPayable,
            GROUP_CONCAT(b.`name`) AS orderProduct,
            a.`status` status
        FROM
            business_order a
        LEFT JOIN customer_base_info base ON base.customer_id = a.customer_id
        LEFT JOIN business_order_product b ON b.order_id = a.order_id
    ]]>
        <isNotEmpty prepend=", " property="enterpriseNature">
            (select * from customer_enterprise_nature where nature=#enterpriseNature#) nature
        </isNotEmpty>
        <isParameterPresent>
            <include refid="OFFER-PAGE-COMMON"/>
            GROUP BY a.order_id
            LIMIT #startRow#,#pageSize#
        </isParameterPresent>
    </select>

    <delete id="DELETE-BY-ID" parameterClass="java.lang.String">
        <![CDATA[
        delete from business_order where order_id = #orderId#
    ]]>
    </delete>

    <select id="ORDER-GET-PAGE" parameterClass="QueryBusinessOrder" resultClass="QueryBusinessOrder">
        SELECT
        a.order_id orderId,
        a.business_id businessId,
        a.sale_organization_name saleOrganizationName,
        a.nc_order_id ncOrderId,
        base.short_name customerName,
        base.country country,
        a.amount_payable amountPayable,
        a.floor_price floorPrice,
        a.is_complaint isComplaint,
        a.is_modify_price isModifyPrice,
        a.net_profit netProfit,
        a.`status` status,
        a.deal_time dealTime
        FROM
        business_order a
        LEFT JOIN customer_base_info base ON base.customer_id = a.customer_id
        <isNotEmpty prepend=", " property="enterpriseNature">
            (select * from customer_enterprise_nature where nature=#enterpriseNature#) nature
        </isNotEmpty>
        <isParameterPresent>
            <include refid="ORDER-PAGE-COMMON"/>
            GROUP BY a.order_id
            limit #startRow#,#pageSize#
        </isParameterPresent>
    </select>

    <select id="COUNT-ORDER" parameterClass="QueryBusinessOrder" resultClass="java.lang.Integer">
        select count(a.order_id) from business_order a
        LEFT JOIN customer_base_info base ON base.customer_id = a.customer_id
        <isNotEmpty prepend=", " property="enterpriseNature">
            (select * from customer_enterprise_nature where nature=#enterpriseNature#) nature
        </isNotEmpty>
        <isParameterPresent>
            <include refid="ORDER-PAGE-COMMON"/>
        </isParameterPresent>
    </select>


    <select id="COUNT-OFFER" parameterClass="QueryBusinessOrder" resultClass="java.lang.Integer">
        select count(a.order_id)
        FROM
        business_order a
        LEFT JOIN customer_base_info base ON base.customer_id = a.customer_id
        LEFT JOIN business_order_product b ON b.order_id = a.order_id
        <isNotEmpty prepend=", " property="enterpriseNature">
            (select * from customer_enterprise_nature where nature=#enterpriseNature#) nature
        </isNotEmpty>
        <isParameterPresent>
            <include refid="OFFER-PAGE-COMMON"/>
        </isParameterPresent>
    </select>

    <select id="query_page" parameterClass="QueryBusinessOrder" resultClass="BusinessOrder">
        select
        sale_organization_name saleOrganizationName,
        order_id orderId,
        nc_order_id ncOrderId,
        amount_payable amountPayable,
        floor_price floorPrice,
        is_complaint isComplaint,
        is_modify_price isModifyPrice,
        net_profit netProfit,
        is_pledge isPledge,
        deal_time dealTime
        from
        business_order
        <isParameterPresent>
            <include refid="QUERY-COMMON"/>
            <isNotEmpty prepend=" AND " property="orderBy">
                order by $orderBy$
            </isNotEmpty>
            limit #startRow#,#pageSize#
        </isParameterPresent>
    </select>

    <select id="count" parameterClass="QueryBusinessOrder" resultClass="java.lang.Integer">
        select count(*) from business_order
        <isParameterPresent>
            <include refid="QUERY-COMMON"/>
        </isParameterPresent>
    </select>

    <sql id="COST-AND-PROFIT-INLINE">
        <dynamic prepend=" WHERE">
            <isNotEmpty prepend=" AND " property="startTime">
                <![CDATA[
                     cvr.start_time >=  #startTime#
                ]]>
            </isNotEmpty>
            <isNotEmpty prepend=" AND " property="endTime">
                <![CDATA[
                     cvr.end_time <=  #startTime#
                ]]>
            </isNotEmpty>
        </dynamic>
    </sql>

    <select id="COST-AND-PROFIT" remapResults="true" parameterClass="CostAndProfitStatistics" resultClass="CostAndProfitStatistics">
        <isEqual property="dimension" compareValue="2">
            <![CDATA[
                        SELECT
                base.customer_id customerId,
                base.full_name customerName,
                base.customer_level customerLevel,
                base.country country,
                SUM(a.actual_amount_paid) actualAmountPaid,
                SUM(a.gross_profit) grossProfit,
                b.maintenance_fee maintenanceFee,
                SUM(a.net_profit) netProfit,
                a.sales_man_name salesManName
            FROM
                business_order a
            LEFT JOIN customer_base_info base ON base.customer_id = a.customer_id
            LEFT JOIN (SELECT
                cvr.customer_id,
                SUM(cvr.activity_expense) maintenance_fee
            FROM
                customer_visit_record cvr
             ]]>
         <isParameterPresent>
             <include refid="COST-AND-PROFIT-INLINE"/>
         </isParameterPresent>
            GROUP BY
            cvr.customer_id) b ON b.customer_id = a.customer_id
            <isParameterPresent>
                <include refid="COST-PROFIT-QUERY-COMMON"/>
                <isNotEmpty prepend=" AND " property="orderBy">
                    order by $orderBy$
                </isNotEmpty>
                GROUP BY a.customer_id
                limit #startRow#,#pageSize#
            </isParameterPresent>
        </isEqual>

        <isEqual property="dimension" compareValue="4">
          <![CDATA[
            SELECT
            bop.`name` productName,
            pi.category_name categoryName,
            SUM(bop.sales_volume) salesVolume,
            SUM(bop.gross_profit) grossProfit,
            SUM(bop.contract_price) salesAmount
            FROM
            business_order_product bop
            LEFT JOIN product_info pi ON pi.product_id = bop.product_id
            WHERE bop.customer_id = #customerId#
            GROUP BY bop.`name`
        ]]>
        </isEqual>

    </select>

    <select id="COUNT-COST-AND-PROFIT" parameterClass="CostAndProfitStatistics" resultClass="java.lang.Integer">
        <![CDATA[
            SELECT
                count(*)
            FROM
                (
                    SELECT
                        count(*)
                    FROM
                        business_order a
                    LEFT JOIN customer_base_info base ON base.customer_id = a.customer_id
             ]]>
        <isParameterPresent>
            <include refid="COST-PROFIT-QUERY-COMMON"/>
            GROUP BY a.customer_id  ) cu
        </isParameterPresent>
    </select>


    <sql id="PROFIT-STATISTICS-QUERY-COMMON">
        <dynamic prepend=" WHERE ">
            <isNotEmpty prepend=" AND " property="customerAreaId">
                base.customer_area_id  = #customerAreaId#
            </isNotEmpty>
            <isNotEmpty prepend=" AND " property="startTime">
                <![CDATA[
                     a.deal_time  >=  #startTime#
                ]]>
            </isNotEmpty>
            <isNotEmpty prepend=" AND " property="endTime">
                <![CDATA[
                     a.deal_time  <=  #endTime#
                ]]>
            </isNotEmpty>
        </dynamic>
    </sql>

    <select id="PROFIT-STATISTICS" remapResults="true" parameterClass="CostAndProfitStatistics" resultClass="CostAndProfitStatistics">
        <isEqual property="dimension" compareValue="0">
            SELECT
            base.customer_area_id customerAreaId,
            base.customer_area customerArea,
            SUM(a.actual_amount_paid) salesAmount,
            SUM(a.gross_profit) grossProfit,
            SUM(a.maintenance_fee) maintenanceFee,
            SUM(a.net_profit) netProfit
            FROM
            customer_base_info base
            LEFT JOIN business_order a ON a.customer_id = base.customer_id
            <isParameterPresent>
                <include refid="PROFIT-STATISTICS-QUERY-COMMON"/>
            </isParameterPresent>
            GROUP BY base.customer_area_id
            ORDER BY netProfit DESC
            limit #startRow#,#pageSize#
        </isEqual>
        <isEqual property="dimension" compareValue="1">
            SELECT
            base.country,
            base.customer_area customerArea,
            SUM(a.actual_amount_paid) salesAmount,
            SUM(a.gross_profit) grossProfit,
            SUM(a.maintenance_fee) maintenanceFee,
            SUM(a.net_profit) netProfit
            FROM
            customer_base_info base
            LEFT JOIN business_order a ON a.customer_id = base.customer_id
            <isParameterPresent>
                <include refid="PROFIT-STATISTICS-QUERY-COMMON"/>
            </isParameterPresent>
            GROUP BY
            base.country_id
            ORDER BY
            netProfit DESC
            <isNotEmpty property="startRow">
                limit #startRow#,#pageSize#
            </isNotEmpty>
        </isEqual>
        <isEqual property="dimension" compareValue="2">
            SELECT
            base.country,
            base.customer_area customerArea,
            base.full_name customerName,
            SUM(a.actual_amount_paid) salesAmount,
            SUM(a.gross_profit) grossProfit,
            SUM(a.maintenance_fee) maintenanceFee,
            SUM(a.net_profit) netProfit,
            a.sales_man_id salesManId,
            a.sales_man_name salesManName
            FROM
            customer_base_info base
            LEFT JOIN business_order a ON a.customer_id = base.customer_id
            <isParameterPresent>
                <include refid="PROFIT-STATISTICS-QUERY-COMMON"/>
            </isParameterPresent>
            GROUP BY
            base.customer_id
            ORDER BY
            netProfit DESC
            limit #startRow#,#pageSize#
        </isEqual>
        <isEqual property="dimension" compareValue="3">
            SELECT
            base.country,
            base.customer_area customerArea,
            base.full_name customerName,
            ua.userArea,
            SUM(a.actual_amount_paid) salesAmount,
            SUM(a.gross_profit) grossProfit,
            SUM(a.maintenance_fee) maintenanceFee,
            SUM(a.net_profit) netProfit,
            a.sales_man_id salesManId,
            a.sales_man_name salesManName
            FROM
            business_order a
            LEFT JOIN customer_base_info base ON a.customer_id = base.customer_id
            LEFT JOIN (
            SELECT
            pua.user_id,
            GROUP_CONCAT(pac.area_name) AS userArea
            FROM
            p_user_area pua
            LEFT JOIN p_area_code pac ON pac.areaid = pua.area_id
            GROUP BY pua.user_id
            ) ua ON ua.user_id =a.sales_man_id
            <isParameterPresent>
                <include refid="PROFIT-STATISTICS-QUERY-COMMON"/>
            </isParameterPresent>
            GROUP BY
            a.sales_man_id
            ORDER BY
            netProfit DESC
            limit #startRow#,#pageSize#
        </isEqual>

        <isEqual property="dimension" compareValue="4">
            SELECT
            a.name productName,
            b.category_name categoryName,
            SUM(a.sales_volume) salesVolume,
            SUM(a.gross_profit) grossProfit,
            SUM(a.gross_margin) grossMargin,
            SUM(a.contract_price) salesAmount
            FROM
            business_order_product a
            LEFT JOIN product_info b ON b.product_id = a.product_id
            <isParameterPresent>
                <include refid="PROFIT-STATISTICS-QUERY-COMMON"/>
            </isParameterPresent>
            GROUP BY
            a.`name`
            ORDER BY
            grossProfit DESC
            limit #startRow#,#pageSize#
        </isEqual>
    </select>

    <select id="COUNT-PROFIT-STATISTICS" parameterClass="CostAndProfitStatistics" resultClass="java.lang.Integer">
        <isEqual property="dimension" compareValue="0">
            select count(*) from (SELECT count(*)
            FROM
            customer_base_info base
            LEFT JOIN business_order a ON a.customer_id = base.customer_id
            <isParameterPresent>
                <include refid="PROFIT-STATISTICS-QUERY-COMMON"/>
            </isParameterPresent>
            GROUP BY base.customer_area_id) temp
        </isEqual>
        <isEqual property="dimension" compareValue="1">
           select count(*) from (SELECT
            count(*)
            FROM
            customer_base_info base
            LEFT JOIN business_order a ON a.customer_id = base.customer_id
            <isParameterPresent>
                <include refid="PROFIT-STATISTICS-QUERY-COMMON"/>
            </isParameterPresent>
            GROUP BY
            base.country_id) temp
        </isEqual>
        <isEqual property="dimension" compareValue="2">
            SELECT count(*) FROM (SELECT
            count(*)
            FROM
            customer_base_info base
            LEFT JOIN business_order a ON a.customer_id = base.customer_id
            <isParameterPresent>
                <include refid="PROFIT-STATISTICS-QUERY-COMMON"/>
            </isParameterPresent>
            GROUP BY
            base.customer_id) temp
        </isEqual>
        <isEqual property="dimension" compareValue="3">
            SELECT count(*) FROM (SELECT
            count(*)
            FROM
            business_order a
            LEFT JOIN customer_base_info base ON a.customer_id = base.customer_id
            LEFT JOIN (
            SELECT
            pua.user_id,
            GROUP_CONCAT(pac.area_name) AS userArea
            FROM
            p_user_area pua
            LEFT JOIN p_area_code pac ON pac.areaid = pua.area_id
            GROUP BY pua.user_id
            ) ua ON ua.user_id =a.sales_man_id
            <isParameterPresent>
                <include refid="PROFIT-STATISTICS-QUERY-COMMON"/>
            </isParameterPresent>
            GROUP BY
            a.sales_man_id) temp
        </isEqual>

        <isEqual property="dimension" compareValue="4">
            SELECT count(*) FROM (SELECT
            count(*)
            FROM
            business_order_product a
            LEFT JOIN product_info b ON b.product_id = a.product_id
            <isParameterPresent>
                <include refid="PROFIT-STATISTICS-QUERY-COMMON"/>
            </isParameterPresent>
            GROUP BY
            a.`name`) temp
        </isEqual>
    </select>

</sqlMap>