<div class="clearfix content shadow-out">
    <!--副导航-->
    <div class="nav-deputy shadow-out clearfix">
        #factoryTab('基本信息',$!{factoryId})
        #breadcrumb()
    </div>
    <!--表格容器-->
    <div class="dashboard-wrapper">
        <div class="row">
            <div class="col-xs-12">
                <!--基本信息-->
                <div class="panel panel-default view-HD-lg" id="panel">
                    <div class="panel-heading">
                        <button class="btn btn-xs btn-primary panel-heading-btn pull-right" name="edit" data-view="editHide" type="button" lang="zh">
                            编辑
                        </button>
                        <div class="but-group btn-group btn-group-xs panel-heading-btn pull-right hidden" data-view="editView">
                            <button class="btn" name="cancel" type="button" lang="zh">取消</button>
                            <button class="btn btn-primary" name="save" type="button" lang="zh">保存</button>
                        </div>
                        <h3 class="panel-title" lang="zh">基本信息</h3>
                    </div>
                    <div class="panel-body clearfix">
                        <form class="form-horizontal" id="factory_info">
                            <div class="hidden">
                                <input name="id" type="text">
                            </div>
                            <div class="form-group">
                                <label class="control-label col-xs-1" for="code" lang="zh">企业代码</label>
                                <div class="col-xs-2">
                                    <input class="form-control" name="code" data-control="editOn" type="text" disabled/>
                                </div>
                                <label class="control-label col-xs-1" for="orgName" lang="zh">所属组织<sup data-view="editView" class="not-null hidden">*</sup></label>
                                <div class="col-xs-2">
                                    <div class="input-group" id="orgName">
                                        <input class="form-control" name="orgName" type="text" disabled>
                                        <div class="input-group-btn">
                                            <button class="btn btn-xs btn-default" data-control="editOn" type="button" disabled>
                                                <span class="glyphicon glyphicon-search"></span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <label class="control-label col-xs-1" for="name" lang="zh">企业名称<sup data-view="editView" class="not-null hidden">*</sup></label>
                                <div class="col-xs-2">
                                    <input class="form-control" name="name" data-control="editOn" type="text" disabled/>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-xs-1" for="abbr" lang="zh">企业简称</label>
                                <div class="col-xs-2">
                                    <input class="form-control" name="abbr" data-control="editOn" type="text" disabled/>
                                </div>
                                <label class="control-label col-xs-1" for="oldName" lang="zh">企业曾用名</label>
                                <div class="col-xs-2">
                                    <input class="form-control" name="oldName" data-control="editOn" type="text" disabled/>
                                </div>
                                <label class="control-label col-xs-1" for="registerfund" lang="zh">注册资金</label>
                                <div class="col-xs-2">
                                    <div class="input-group">
                                        <input class="form-control" name="registerfund" data-control="editOn" type="text" disabled/>
                                        <span class="input-group-addon" data-val="美元" lang="zh">万元</span>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-xs-1" for="address" lang="zh">注册地址</label>
                                <div class="col-xs-8">
                                    <textarea class="form-control" name="address" data-control="editOn" rows="2" disabled></textarea>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-xs-1" for="cooperateTime" lang="zh">开始合作时间</label>
                                <div class="col-xs-2">
                                    <input class="form-control" name="cooperateTime" data-control="editOn" type="date" disabled/>
                                </div>
                                <label class="control-label col-xs-1" for="coopMonths" lang="zh">合作时间</label>
                                <div class="col-xs-2">
                                    <div class="input-group">
                                        <input class="form-control" name="coopMonths" type="text" disabled/>
                                        <span class="input-group-addon" lang="zh">月</span>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-xs-1" for="productionLicenses" lang="zh">生产许可证<sup data-view="editView" class="not-null hidden">*</sup></label>
                                <div class="col-xs-3">
                                    <div class="input-group">
                                        <input class="form-control" name="productionLicenses" data-control="editOn" type="text" disabled/>
                                        <div class="input-group-btn" lang="zh">
                                            <button class="btn btn-xs btn-primary hidden" data-view="editView" type="button" lang="zh">修改</button>
                                            <button class="btn btn-xs btn-primary" type="button" lang="zh">查看</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-xs-1" for="pesticideRegistration" lang="zh">农药登记证<sup data-view="editView" class="not-null hidden">*</sup></label>
                                <div class="col-xs-3">
                                    <div class="input-group">
                                        <input class="form-control" name="pesticideRegistration" data-control="editOn" type="text" disabled/>
                                        <div class="input-group-btn" lang="zh">
                                            <button class="btn btn-xs btn-primary hidden" data-view="editView" type="button" lang="zh">修改</button>
                                            <button class="btn btn-xs btn-primary" type="button" lang="zh">查看</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-xs-1" for="dischargePermit" lang="zh">排污许可证<sup data-view="editView" class="not-null hidden">*</sup></label>
                                <div class="col-xs-3">
                                    <div class="input-group">
                                        <input class="form-control" name="dischargePermit" data-control="editOn" type="text" disabled/>
                                        <div class="input-group-btn" lang="zh">
                                            <button class="btn btn-xs btn-primary hidden" data-view="editView" type="button" lang="zh">修改</button>
                                            <button class="btn btn-xs btn-primary" type="button" lang="zh">查看</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-xs-1" for="remark" lang="zh">备注</label>
                                <div class="col-xs-8">
                                    <textarea class="form-control" name="remark" data-control="editOn" rows="4" disabled></textarea>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-xs-1" for="supstate">状态<sup data-view="editView" class="not-null hidden">*</sup></label>
                                <div class="col-xs-2">
                                    <select class="form-control" name="supstate" data-control="editOn" disabled>
                                        <option value="1">启用</option>
                                        <option value="0">禁用</option>
                                    </select>
                                </div>
                                <label class="control-label col-xs-1" for="score" lang="zh">综合评分</label>
                                <div class="col-xs-2">
                                    <input class="form-control" name="score" data-control="editOn" type="text" disabled/>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-xs-1" for="managerOrgName" lang="zh">管理员组织<sup data-view="editView" class="not-null hidden">*</sup></label>
                                <div class="col-xs-2">
                                    <div class="input-group" id="managerOrgName">
                                        <input class="form-control" name="managerOrgName" type="text" disabled>
                                        <div class="input-group-btn">
                                            <button class="btn btn-xs btn-default" data-control="editOn" type="button" disabled>
                                                <span class="glyphicon glyphicon-search"></span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <label class="control-label col-xs-1" for="managerDepName" lang="zh">管理员部门<sup data-view="editView" class="not-null hidden">*</sup></label>
                                <div class="col-xs-2">
                                    <div class="input-group" id="managerDepName">
                                        <input class="form-control" name="managerDepName" type="text" disabled>
                                        <div class="input-group-btn">
                                            <button class="btn btn-xs btn-default" data-control="editOn" type="button" disabled>
                                                <span class="glyphicon glyphicon-search"></span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <label class="control-label col-xs-1" for="manager" lang="zh">工厂管理员<sup data-view="editView" class="not-null hidden">*</sup></label>
                                <div class="col-xs-2">
                                    <div class="input-group" id="manager">
                                        <input class="form-control" name="manager" type="text" disabled>
                                        <div class="input-group-btn">
                                            <button class="btn btn-xs btn-default" data-control="editOn" type="button" disabled>
                                                <span class="glyphicon glyphicon-search"></span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-xs-1" for="banks" lang="zh">银行账户</label>
                                <div class="col-xs-8">
                                    <table class="table text-center table-condensed table-bordered table-hover" id="bank_table">
                                        <caption class="hidden text-right" data-view="editView">
                                            <button class="btn-link" name="addBtn" data-control="editOn" type="button" disabled>新增</button>
                                            <button class="btn-link" name="delBtn" data-control="editOn" type="button" disabled>删除</button>
                                        </caption>
                                        <thead>
                                        <tr>
                                            <th class="hidden text-center col-xs-1" data-view="editView">
                                                <div class="checkbox">
                                                    <label for="checkedAll">
                                                        <input name="checkedAll" type="checkbox">
                                                    </label>
                                                </div>
                                            </th>
                                            <th class="text-center" lang="zh">账号</th>
                                            <th class="text-center" lang="zh">户名</th>
                                            <th class="text-center" lang="zh">开户银行</th>
                                            <th class="text-center" lang="zh">银行类别</th>
                                            <th class="text-center" lang="zh">币种</th>
                                        </tr>
                                        </thead>
                                        <tbody name="banks"></tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-xs-1" for="contacts" lang="zh">联系人</label>
                                <div class="col-xs-8">
                                    <table class="table text-center table-condensed table-bordered table-striped" id="contact_table">
                                        <caption class="hidden text-right" data-view="editView">
                                            <button class="btn-link" data-control="editOn" type="button" disabled>新增</button>
                                            <button class="btn-link" data-control="editOn" type="button" disabled>删除</button>
                                        </caption>
                                        <thead>
                                        <tr>
                                            <th class="hidden text-center col-xs-1" data-view="editView">
                                                <div class="checkbox">
                                                    <label for="checkedAll">
                                                        <input name="checkedAll" type="checkbox">
                                                    </label>
                                                </div>
                                            </th>
                                            <th class="text-center col-xs-3" lang="zh">姓名</th>
                                            <th class="text-center col-xs-4" lang="zh">联系电话</th>
                                            <th class="text-center col-xs-4" lang="zh">邮箱</th>
                                        </tr>
                                        </thead>
                                        <tbody name="contacts"></tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="form-group" data-view="editHide">
                                <label class="control-label col-xs-1" for="modifyName" lang="zh">最后编辑人</label>
                                <div class="col-xs-2">
                                    <input class="form-control" name="modifyName" type="text" disabled/>
                                </div>
                                <label class="control-label col-xs-1" for="modifyTime" lang="zh">编辑时间</label>
                                <div class="col-xs-2">
                                    <input class="form-control" name="modifyTime" type="text" disabled/>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

## 确认提交modal
<div class="modal fade" id="upModal" data-backdrop="false" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" style="width: 370px;margin-top: 168px">
        <div class="modal-content">
            <div class="modal-body clearfix">
                <h4 class="text-info text-center">请确认是否提交表单？</h4>
                <hr>
                <div class="col-xs-5 col-xs-offset-1"><button class="btn btn-block btn-primary" id="upForm" data-dismiss="modal" type="button">确定</button></div>
                <div class="col-xs-5"><button class="btn btn-default btn-block" data-dismiss="modal" type="button">取消</button></div>
            </div>
        </div>
    </div>
</div>

## 银行详情modal
<div class="modal fade" id="bank_modal" data-backdrop="true" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    ×
                </button>
            </div>
            <div class="modal-body clearfix">
                <form class="form-horizontal well" id="back_form" style="margin-bottom: 0;">
                    <div class="form-group">
                        <label class="control-label col-xs-2" for="accnum">银行账号<sup data-view="editView" class="not-null hidden">*</sup></label>
                        <div class="col-xs-4">
                            <input class="form-control" name="accnum" data-control="editOn" type="text">
                        </div>
                        <label class="control-label col-xs-2" for="accname">银行户名<sup data-view="editView" class="not-null hidden">*</sup></label>
                        <div class="col-xs-4">
                            <input class="form-control" name="accname" data-control="editOn" type="text">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-xs-2" for="currtypeName">币种<sup data-view="editView" class="not-null hidden">*</sup></label>
                        <div class="col-xs-4">
                            <select class="form-control" name="currtypeName" data-control="editOn" id=""></select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-xs-2" for="pkBanktype">银行类别<sup data-view="editView" class="not-null hidden">*</sup></label>
                        <div class="col-xs-4">
                            <select class="form-control" name="pkBanktype" data-control="editOn" id="bank_first"></select>
                        </div>
                        <label class="control-label col-xs-2" for="pkBankdoc">开户银行<sup data-view="editView" class="not-null hidden">*</sup></label>
                        <div class="col-xs-4">
                            <select class="form-control" name="pkBankdoc" data-control="editOn" id="bank_second">
                                <option value="" title="请先选择银行类别">——请先选择银行类别——</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <div class="row">
                    <div class="col-xs-4 pull-right hidden" data-view="editView">
                        <div class="btn-group btn-block">
                            <button class="btn btn-xs btn-default col-xs-6" name="cancel" type="button" lang="zh">取消</button>
                            <button class="btn btn-xs btn-primary col-xs-6" name="save" type="button" lang="zh">保存</button>
                        </div>
                    </div>
                    <div class="col-xs-2 pull-right" data-view="editHide">
                        <button class="btn btn-xs btn-block btn-primary" name="edit" type="button" lang="zh">编辑</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

## 联系人modal
<div class="modal fade" id="contact_modal" data-backdrop="true" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    ×
                </button>
            </div>
            <div class="modal-body clearfix">
                <form class="form-horizontal well" id="contact_form" style="margin-bottom: 0;">
                    <div class="form-group">
                        <label class="control-label col-xs-4" for="name">姓名<sup class="not-null">*</sup></label>
                        <div class="col-xs-8">
                            <input class="form-control" name="name" type="text">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-xs-4" for="phone">联系电话</label>
                        <div class="col-xs-8">
                            <input class="form-control" name="phone" type="tel">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-xs-4" for="email">邮箱</label>
                        <div class="col-xs-8">
                            <input class="form-control" name="email" type="email">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <div class="row">
                    <div class="col-xs-4 col-xs-offset-2">
                        <button class="btn btn-xs btn-block btn-default" name="cancel" type="button" lang="zh">取消</button>
                    </div>
                    <div class="col-xs-4">
                        <button class="btn btn-xs btn-block btn-primary" name="save" type="button" lang="zh">保存</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<input id="factoryId" type="hidden" value="$!{factoryId}">
<script>
    $(function () {
        // 加工厂id
        var id = $('#factoryId').val();

        // 银行账户table组件
        var bankTable = {
            table:$('#bank_table'),
            addBtn:'[name="addBtn"]',
            delBtn:'[name="delBtn"]',
            dtlBtn:'[name="dtlBtn"]',
            chkAllBtn:$('[name="checkedAll"]', $('#bank_table')),
            container:$('[name="banks"]', $('#bank_table')),
            argsIds:[], // 删除的项目的id
            argsIndex:[], // 删除的对象在数组中的下标
            param:{
                url:basePath+'/supplier/factories/'+id+'/banks',
                type:'GET'
            },
            data:null, // 请求的数据对象
            ectype:null, // 数据对象副本
            item:null,
            init:function () {
                this.refresh();
                this.addEvent('click.checkedAll', '[name="checkedAll"]', this.checkedAllHandler);
                this.addEvent('click.delItem', '[name="delBtn"]', this.deleteHandler);
                this.addEvent('click.dtlBtn', '[name="dtlBtn"]', this.showModalHandler);
                this.addEvent('click.addBtn', '[name="addBtn"]', this.addHandler);
            },
            refresh:function () {
                bankTable.empty();
                var container = this.container;
                $.ajax(this.param).done(function (res) {

                    if (res.code!==1) return;

                    bankTable.data = res.data;
                    bankTable.ectype = $.extend(true, [], bankTable.data); // 深拷贝一份数据对象的副本
                    container.html(bankTable.render(bankTable.data));
                });
            },
            empty:function () {
                this.container.html('');
            },
            render:function (list) {
                var tpl = '';
                $.each(list, function(i, item){
                    tpl +=
                            '<tr>' +
                            '<td class="hidden" data-view="editView"><div class="checkbox"><label for="checkedOne">' +
                            '<input name="checkedOne" type="checkbox" value="'+bankTable.hasField(item.id)+'">' +
                            '</label></div></td>'+
                            '<td class="hidden" data-view="editView"><a href="#" name="dtlBtn" title="'+bankTable.hasField(item.accnum)+'">'+bankTable.hasField(item.accnum)+'</a></td>'+
                            '<td data-view="editHide" title="'+bankTable.hasField(item.accnum)+'">'+bankTable.hasField(item.accnum)+'</td>'+
                            '<td title="'+bankTable.hasField(item.accname)+'">'+bankTable.hasField(item.accname)+'</td>'+
                            '<td title="'+bankTable.hasField(item.pkBankdoc)+'">'+bankTable.hasField(item.bankDocName)+'</td>'+
                            '<td title="'+bankTable.hasField(item.pkBanktype)+'">'+bankTable.hasField(item.bankTypeName)+'</td>'+
                            '<td title="'+bankTable.hasField(item.pkCurrtype)+'">'+bankTable.hasField(item.currtypeName)+'</td>'+
                            '</tr>';
                });
                return tpl;
            },
            hasField:function (field) {

                if (field===null||field===undefined){
                    return '';
                }else {
                    return field;
                }
            },
            addEvent:function (eType, el, handler) {
                this.table.off(eType).on(eType, el, handler);
            },
            checkedAllHandler:function () { // 全选

                if (bankTable.chkAllBtn.prop('checked')) {

                    bankTable.container.find('input').prop('checked', true);
                }else {
                    bankTable.container.find('input').prop('checked', false);
                }
            },
            deleteHandler:function () { // 删除
                var el = bankTable.container.find('input');

                if (el.filter(':checked').length>0) {

                    if (!confirm('确定要删除这些项吗？')) return;

                    el.each(function (i) {

                        if ($(this).prop('checked')) {

                            bankTable.argsIndex.push(i); // 取得选中项的下标数组
                            return true;
                        }else{
                            return true;
                        }
                    });

                    bankTable.data = bankTable.data.filter(function (v, i, args) {

                        if (bankTable.argsIndex.indexOf(i)>-1 && typeof args[i].id==='number') {

                            bankTable.argsIds.push(args[i].id); // 取得删除项的id数组
                        }
                        return bankTable.argsIndex.indexOf(i)===-1;
                    });

                    bankTable.container.html(bankTable.render(bankTable.data)); // 刷新列表
                    bankTable.argsIndex = []; // 重置选中项的下标数组
                    basicPanel.editForm();
                }else {
                    alert('请选择要删除的项！');
                }
            },
            showModalHandler:function (e) {
                e.preventDefault();
                var i = $(this).closest('tr').index();
                bankTable.item = bankTable.data[i]; // 取得列表中的当前项
                bankModal.modal.modal('show');
                bankModal.init(bankTable.item);
            },
            addHandler:function () {
                bankTable.item = null; // 用来判断bankModal的保存操作是执行新增，还是编辑
                bankModal.init();
                bankModal.modal.modal('show');
            }
        };
        bankTable.init();

        // 银行账户modal组件
        var bankModal = {
            modal:$('#bank_modal'),
            form:$('#back_form'),
            editBtn:'[name="edit"]',
            saveBtn:'[name="save"]',
            cancelBtn:'[name="cancel"]',
            editView:'[data-view="editView"]',
            editHide:'[data-view="editHide"]',
            editOn:'[data-control="editOn"]',
            editOff:'[data-control="editOff"]',
            init:function (item) {
                bankModal.empty();

                if (item!==undefined && item!==null) {

                    bankModal.render(item);
                    /*bankModal.viewForm();*/
                    /*this.addEvent('click.edit', '[name="edit"]', this.editHandler);*/
                }
                bankModal.editForm();
                this.addEvent('click.cancel', '[name="cancel"]', this.cancelHandler);
                this.addEvent('click.save', '[name="save"]', this.saveHandler);
            },
            render:function (data) {
                $('[name="accnum"]', bankModal.form).val(data.accnum); // 银行账号
                $('[name="accname"]', bankModal.form).val(data.accname); // 银行户名
                $('[name="currtypeName"]', bankModal.form).val(data.pkCountry); // 币种
                $('[name="pkBanktype"]', bankModal.form).val(data.pkBanktype); // 银行类别
                bankLinkage.firstChangeHandler(); // 根据银行类别渲染开户银行
                $('[name="pkBankdoc"]', bankModal.form).val(data.pkBankdoc); // 开户银行
            },
            empty:function () {
                bankModal.form[0].reset();
            },
            editForm:function () {
                $(bankModal.editOn, bankModal.form).attr('disabled', false);
                $(bankModal.editOff, bankModal.form).attr('disabled', true);
                $(bankModal.editView, bankModal.modal).removeClass('hidden');
                $(bankModal.editHide, bankModal.modal).addClass('hidden');
            },
            viewForm:function () {
                $(bankModal.editOn, bankModal.form).attr('disabled', true);
                $(bankModal.editOff, bankModal.form).attr('disabled', false);
                $(bankModal.editView, bankModal.modal).addClass('hidden');
                $(bankModal.editHide, bankModal.modal).removeClass('hidden');
            },
            addEvent:function (eType, el, handler) {
                this.modal.off(eType).on(eType, el, handler);
            },
            editHandler:function () {
                bankModal.editForm();
            },
            cancelHandler:function () {

                if (confirm('确定取消保存吗？')) {

                    bankModal.modal.modal('hide');
                }
            },
            saveHandler:function () {

                if (!confirm('确定要保存吗？')) return;

                var isAdd = (bankTable.item === null);

                if (isAdd) bankTable.item = {};

                bankTable.item.accnum = $('[name="accnum"]', bankModal.form).val();
                bankTable.item.accname = $('[name="accname"]', bankModal.form).val();
                bankTable.item.pkCountry = $('[name="currtypeName"]', bankModal.form).val();
                bankTable.item.currtypeName = $('[name="currtypeName"]', bankModal.form).find('option').filter(':selected').text().trim();
                bankTable.item.pkBankdoc = $('[name="pkBankdoc"]', bankModal.form).val();
                bankTable.item.bankDocName = $('[name="pkBankdoc"]', bankModal.form).find('option').filter(':selected').text().trim();
                bankTable.item.pkBanktype = $('[name="pkBanktype"]', bankModal.form).val();
                bankTable.item.bankTypeName = $('[name="pkBanktype"]', bankModal.form).find('option').filter(':selected').text().trim();

                if (isAdd) bankTable.data.push(bankTable.item);

                bankTable.container.html(bankTable.render(bankTable.data)); // 刷新列表
                bankModal.modal.modal('hide');
                basicPanel.editForm();
            }
        };

        // 银行联动选择框
        var bankLinkage = {
            firstSelect:$('#bank_first'),
            secondSelect:$('#bank_second'),
            firstParam:{
                url:basePath+'/bank/type',
                type:'GET'
            },
            secondParam:{
                url:basePath+'/bank/docs',
                type:'GET',
            },
            init:function () {
              $.ajax(bankLinkage.firstParam).done(function (res) {

                  if (res.code === 1 && res.data instanceof Array) {

                      bankLinkage.firstSelect.html(bankLinkage.renderFirst(res.data));
                  }
              });
              bankLinkage.addEvent('change.firstSelect', this.firstChangeHandler);
            },
            renderFirst:function (list) {
                var tpl = '';
                $.each(list, function (i, item) {
                    tpl += '<option value="' + item.pkBanktype + '" title="' + item.pkBanktype + '">' + item.name + '</option>';
                });
                return tpl;
            },
            renderSecond:function (list) {
                var tpl = '';
                $.each(list, function (i, item) {
                    tpl += '<option value="' + item.pkBankdoc + '" title="' + item.pkBankdoc + '">' + item.name + '</option>';
                });
                return tpl;
            },
            resetSecond:function () {
                var tpl = '<option value="" title="请先选择银行类别">——请先选择银行类别——</option>';
                bankLinkage.secondSelect.html(tpl);
            },
            addEvent:function (eType, handler) {
                this.firstSelect.off(eType).on(eType, handler);
            },
            firstChangeHandler:function () {
                bankLinkage.secondParam.data = {
                    pkBanktype:$('#bank_first').val()
                };
                bankLinkage.resetSecond();
                $.ajax(bankLinkage.secondParam).done(function (res) {

                    if (res.code === 1 && res.data instanceof Array) {

                        bankLinkage.secondSelect.html(bankLinkage.renderSecond(res.data));
                    }else {
                        bankLinkage.secondSelect.html('<option value="">暂无数据</option>');
                    }
                });
            }
        };
        bankLinkage.init();

        // 联系人table组件
        var contactTable = {
            table:$('#contact_table'),
            addBtn:'[name="addBtn"]',
            delBtn:'[name="delBtn"]',
            dtlBtn:'[name="dtlBtn"]',
            chkAllBtn:$('[name="checkedAll"]', $('#contact_table')),
            container:$('[name="contacts"]', $('#contact_table')),
            param:{
                url:basePath+'/supplier/factories/'+id+'/linkmen',
                type:'GET'
            },
            argsIds:[], // 删除的项目的id
            argsIndex:[], // 删除的对象在数组中的下标
            data:null, // 请求的数据对象
            ectype:null, // 数据对象副本
            item:null,
            init:function () {
                this.refresh();
                this.addEvent('click.checkedAll', '[name="checkedAll"]', this.checkedAllHandler);
                this.addEvent('click.delItem', '[name="delBtn"]', this.deleteHandler);
                this.addEvent('click.dtlBtn', '[name="dtlBtn"]', this.showModalHandler);
                this.addEvent('click.addBtn', '[name="addBtn"]', this.addHandler);
            },
            refresh:function () {
                contactTable.empty();
                var container = this.container;
                $.ajax(this.param).done(function (res) {

                    if (res.code!==1) return;

                    contactTable.data = res.data;
                    contactTable.ectype = $.extend(true, [], contactTable.data); // 深拷贝一份数据对象的副本
                    container.html(contactTable.render(contactTable.data));
                });
            },
            empty:function () {
                this.container.html('');
            },
            render:function (list) {
                var tpl = '';
                $.each(list, function(i, item){
                    tpl +=
                            '<tr>' +
                            '<td class="hidden" data-view="editView"><div class="checkbox"><label for="checkedOne">' +
                            '<input name="checkedOne" type="checkbox" value="'+contactTable.hasField(item.id)+'">' +
                            '</label></div></td>'+
                            '<td class="hidden" data-view="editView"><a href="#" name="dtlBtn" title="'+contactTable.hasField(item.name)+'">'+contactTable.hasField(item.name)+'</a></td>'+
                            '<td data-view="editHide" title="'+contactTable.hasField(item.name)+'">'+contactTable.hasField(item.name)+'</td>'+
                            '<td title="'+contactTable.hasField(item.phone)+'">'+contactTable.hasField(item.phone)+'</td>'+
                            '<td title="'+contactTable.hasField(item.email)+'">'+contactTable.hasField(item.email)+'</td>'+
                            '</tr>';
                });
                return tpl;
            },
            hasField:function (field) {

                if (field===null||field===undefined){
                    return '';
                }else {
                    return field;
                }
            },
            addEvent:function (eType, el, handler) {
                this.table.off(eType).on(eType, el, handler);
            },
            checkedAllHandler:function () { // 全选

                if (contactTable.chkAllBtn.prop('checked')) {

                    contactTable.container.find('input').prop('checked', true);
                }else {
                    contactTable.container.find('input').prop('checked', false);
                }
            },
            deleteHandler:function () { // 删除
                var el = contactTable.container.find('input');

                if (el.filter(':checked').length>0) {

                    if (!confirm('确定要删除这些项吗？')) return;

                    el.each(function (i) {

                        if ($(this).prop('checked')) {

                            contactTable.argsIndex.push(i); // 取得选中项的下标数组
                            return true;
                        }else{
                            return true;
                        }
                    });

                    contactTable.data = contactTable.data.filter(function (v, i, args) {

                        if (contactTable.argsIndex.indexOf(i)>-1 && typeof args[i].id==='number') {

                            contactTable.argsIds.push(args[i].id); // 取得删除项的id数组
                        }
                        return contactTable.argsIndex.indexOf(i)===-1;
                    });

                    contactTable.container.html(contactTable.render(contactTable.data)); // 刷新列表
                    contactTable.argsIndex = []; // 重置选中项的下标数组
                    basicPanel.editForm();
                }else {
                    alert('请选择要删除的项！');
                }
            },
            showModalHandler:function (e) {
                e.preventDefault();
                var i = $(this).closest('tr').index();
                bankTable.item = bankTable.data[i]; // 取得列表中的当前项
                contactModal.modal.modal('show');
                contactModal.init(bankTable.item);
            },
            addHandler:function () {
                bankTable.item = null; // 用来判断bankModal的保存操作是执行新增，还是编辑
                bankModal.init();
                bankModal.modal.modal('show');
            }
        };

        // 联系人modal组件
        var contactModal = {
            modal:$('#contact_modal'),
            form:$('#contact_form'),
            saveBtn:'[name="save"]',
            cancelBtn:'[name="cancel"]',
            init:function (item) {
                contactModal.empty();

                if (item!==undefined && item!==null) {

                    contactModal.render(item);
                }
                this.addEvent('click.cancel', '[name="cancel"]', this.cancelHandler);
                this.addEvent('click.save', '[name="save"]', this.saveHandler);
            },
            render:function (data) {
                $('[name="name"]', contactModal.form).val(data.name);
                $('[name="phone"]', contactModal.form).val(data.phone);
                $('[name="email"]', contactModal.form).val(data.email);
            },
            empty:function () {
                contactModal.form[0].reset();
            },
            addEvent:function (eType, el, handler) {
                this.modal.off(eType).on(eType, el, handler);
            },
            cancelHandler:function () {

                if (confirm('确定取消保存吗？')) {

                    contactModal.modal.modal('hide');
                }
            },
            saveHandler:function () {

                if (!confirm('确定要保存吗？')) return;

                var isAdd = (contactTable.item === null);

                if (isAdd) contactTable.item = {};

                contactTable.item.accnum = $('[name="accnum"]', bankModal.form).val();
                contactTable.item.accname = $('[name="accname"]', bankModal.form).val();
                contactTable.item.pkCountry = $('[name="currtypeName"]', bankModal.form).val();
                contactTable.item.currtypeName = $('[name="currtypeName"]', bankModal.form).find('option').filter(':selected').text().trim();
                contactTable.item.pkBankdoc = $('[name="pkBankdoc"]', bankModal.form).val();
                contactTable.item.bankDocName = $('[name="pkBankdoc"]', bankModal.form).find('option').filter(':selected').text().trim();
                contactTable.item.pkBanktype = $('[name="pkBanktype"]', bankModal.form).val();
                contactTable.item.bankTypeName = $('[name="pkBanktype"]', bankModal.form).find('option').filter(':selected').text().trim();contactTable
                if (isAdd) bankTable.data.push(bankTable.item);

                bankTable.container.html(bankTable.render(bankTable.data)); // 刷新列表
                bankModal.modal.modal('hide');
                basicPanel.editForm();
            }
        };

        // 基本信息组件
        var basicPanel = {
            panel:$('#panel'),
            form:$('#factory_info'),
            editBtn:'[name="edit"]',
            saveBtn:'[name="save"]',
            cancelBtn:'[name="cancel"]',
            editView:'[data-view="editView"]',
            editHide:'[data-view="editHide"]',
            editOn:'[data-control="editOn"]',
            editOff:'[data-control="editOff"]',
            paramGet:{
                url:basePath+'/supplier/factories/'+id,
                type:'GET'
            },
            paramPut:{
                url:basePath+'/supplier/factories/'+id,
                type:'PUT',
                contentType:'application/json;charset=UTF-8'
            },
            data:null,
            ectype:null,
            formConfig:[
                {
                    name:'code'
                },
                {
                    name:'orgName',
                    place:{
                        name:'id',
                        field:'pkOrg'
                    }
                },
                {
                    name:'name'
                },
                {
                    name:'abbr'
                },
                {
                    name:'oldName'
                },
                {
                    name:'registerfund'
                },
                {
                    name:'address'
                },
                {
                    name:'cooperateTime'
                },
                {
                    name:'productionLicenses'
                },
                {
                    name:'pesticideRegistration'
                },
                {
                    name:'dischargePermit'
                },
                {
                    name:'remark'
                },
                {
                    name:'score',
                },
                {
                    name:'managerOrgName',
                    place:{
                        name:'id',
                        field:'managerOrgCode'
                    }
                },
                {
                    name:'managerDepName',
                    place:{
                        name:'id',
                        field:'managerDepCode'
                    }
                },
                {
                    name:'manager',
                    place:{
                        name:'id',
                        field:'managerCode'
                    }
                },
            ],
            init:function (item) {

                if (this.id!=='') { // 如果有id初始化为查看状态，并获取数据

                    this.viewForm();
                    $.ajax(this.paramGet).done(function (res) {

                        if (res.code===1) {

                            basicPanel.data = res.data;
                            basicPanel.ectype = $.extend(true, {}, basicPanel.data);
                            basicPanel.render(basicPanel.data);
                        }

                    });
                    this.addEvent('click.edit', '[name="edit"]', this.editHandler);
                }else { // 或者初始化为新增状态

                    this.editForm();
                }

                this.addEvent('click.cancel', '[name="cancel"]', this.cancelHandler);
                this.addEvent('click.save', '[name="save"]', this.saveHandler);
            },
            render:function (data) {
                /*{
                    name:'code',
                    type:'normal/select/list/other',
                    place:'存储位置',
                    listTpl:'list模板',
                    field:'对应字段'
                }*/
                $.each(basicPanel.formConfig, function (i, item) {

                    var field = item.field || item.name;
                    if (item.type==='normal' || typeof item.type==='undefined') {

                        if (typeof item.place==='object') {

                            $('[name="'+item.name+'"]', basicPanel.form)
                                    .data(item.place.name, data[item.place.field])
                                    .val(data[field])
                                    .attr('title', data[item.place.field]);
                        }else {
                            $('[name="'+item.name+'"]', basicPanel.form)
                                    .val(data[field])
                                    .attr('title', data[field.name]);
                        }
                    }/*else if (item.type==='select') {

                        if (typeof filed==='object') {

                            $('[name="'+item.name+'"]', form).html('<option value="'+data[field.name]+'">'+data[field.value]+'</option>');
                        }else {

                            $('[name="'+item.name+'"]', form).val(data[field]);
                        }
                    }*/
                })
            },
            empty:function () {
                basicPanel.form[0].reset();
            },
            editForm:function () {
                $(basicPanel.editOn, basicPanel.panel).attr('disabled', false);
                $(basicPanel.editOff, basicPanel.panel).attr('disabled', true);
                $(basicPanel.editView, basicPanel.panel).removeClass('hidden');
                $(basicPanel.editHide, basicPanel.panel).addClass('hidden');
            },
            viewForm:function () {
                $(basicPanel.editOn, basicPanel.panel).attr('disabled', true);
                $(basicPanel.editOff, basicPanel.panel).attr('disabled', false);
                $(basicPanel.editView, basicPanel.panel).addClass('hidden');
                $(basicPanel.editHide, basicPanel.panel).removeClass('hidden');
            },
            addEvent:function (eType, el, handler) {
                this.panel.off(eType).on(eType, el, handler);
            },
            editHandler:function () {
                basicPanel.editForm();
            },
            cancelHandler:function () {

                if (!confirm('确定取消保存吗？')) return;
                basicPanel.data = $.extend(true, {}, basicPanel.ectype); // 重置data数据
                bankTable.data = $.extend(true, [], bankTable.ectype);
                basicPanel.empty();
                basicPanel.render(basicPanel.data); // 重新渲染
                bankTable.container.html(bankTable.render(bankTable.data)); // 刷新列表
                basicPanel.viewForm();
            },
            saveHandler:function () {

                if (!confirm('确定要保存吗？')) return;
                basicPanel.viewForm();
                basicPanel.getData();
                basicPanel.data.banks = bankTable.data;
                basicPanel.data.deletedBankIds = bankTable.argsIds;
                basicPanel.paramPut.data = JSON.stringify(basicPanel.data);

                if (id!=='') { // 更新

                    basicPanel.putData();
                }else {


                }
            },
            getData:function () {
                $.each(basicPanel.formConfig, function (i, item) {

                    if (item.type==='normal' || typeof item.type==='undefined') {

                        if (typeof item.place==='object') {
                            basicPanel.data[item.name] = $('[name="'+item.name+'"]', basicPanel.form).val().trim();
                            basicPanel.data[item.place.field] = $('[name="'+item.name+'"]', basicPanel.form).data(item.place.name);

                        }else {

                            basicPanel.data[item.name] = $('[name="'+item.name+'"]', basicPanel.form).val().trim();
                        }
                    }
                })
            },
            putData:function () {

                $.ajax(basicPanel.paramPut).done(function (res) {

                    if (res.code===1) {
                        alert('更新成功！');
                    }
                })
            },
            postData:function () {

            }
        };
        basicPanel.init();
    });

</script>
