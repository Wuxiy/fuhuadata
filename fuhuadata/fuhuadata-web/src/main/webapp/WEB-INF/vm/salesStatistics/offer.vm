<div class="nav-deputy shadow-out clearfix">
    <ul class="breadcrumb pull-right">
        <li><span class="glyphicon glyphicon-map-marker"></span></li>
    </ul>
</div>

<div class="dashboard-wrapper">
    <div class="row">
        <!--树形导航开始-->
        <div class="col-xs-2">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title" lang="zh">
                        地区分类
                    </h3>
                </div>
                <div class="panel-body clearfix">
                    <!--树形菜单-->
                    <div id="tree" class="tree"></div>
                </div>
            </div>
        </div>
        <!--列表部分-->
        <div class="tab-content col-xs-10">
            <div class="nav-deputy shadow-out clearfix" style="margin-bottom: 10px; ">
                #saleNav(2)
                <div class="panel-heading">
                    <div class="btn-group btn-group-xs panel-heading-btn pull-right">
                        <a class="btn btn-xs btn-primary panel-heading-btn" href="" data-toggle="modal">
                            <span class="glyphicon glyphicon-plus"></span>
                            新增商机
                        </a>
                        <a class="btn btn-primary" href="">直接报价</a>
                    </div>
                </div>
            </div>
            <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title" lang="zh">
                            报价列表
                        </h3>
                    </div>
                    <div class="panel-body clearfix">
                        <!--搜索&筛选控件-->
                        <div class="form-horizontal">
                            <div class="form-group">
                                <div class="col-xs-10 pull-right">
                                    <!--搜索栏-->
                                    <form class="input-group">
                                        <span class="input-group-addon" lang="zh">客户名称</span>
                                        <input class="form-control" type="text" value="" id="customerName" />
                                        <span class="input-group-addon" lang="zh">订单编号</span>
                                        <input class="form-control" type="text" value="" id="orderId"/>
                                        <span class="input-group-addon" lang="zh">订单状态</span>
                                        <select class="form-control" id="orderStatus">
                                            <option value="" selected lang="zh">全部</option>
                                            <option value="0" lang="zh">待下单</option>
                                            <option value="1" lang="zh">失败</option>
                                            <option value="2" lang="zh">已下单</option>
                                        </select>
                                        <span class="input-group-addon" lang="zh">客户类型</span>
                                        <select class="form-control" id="customerLevel">
                                            <option value="" selected lang="zh">全部</option>
                                            <option value="5" lang="zh">风险客户</option>
                                            <option value="4" lang="zh">一般客户</option>
                                            <option value="3" lang="zh">重要客户</option>
                                            <option value="2" lang="zh">大客户</option>
                                            <option value="1" lang="zh">战略客户</option>
                                        </select>
                                        <span class="input-group-addon" lang="zh">企业性质</span>
                                        <select class="form-control" id="enterpriseNature">
                                            <option value="" selected lang="zh">全部</option>
                                            <option value="1" lang="zh">工厂</option>
                                            <option value="2" lang="zh">分销商</option>
                                            <option value="3" lang="zh">经销商</option>
                                            <option value="4" lang="zh">终端客户</option>
                                            <option value="5" lang="zh">其他</option>
                                        </select>
                                        <div class="input-group-btn">
                                            <button class="btn btn-xs btn-default" type="reset">重置</button>
                                        </div>
                                        <div class="input-group-btn">
                                            <button class="btn btn-xs btn-primary" id="submit" type="button">搜索</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <!--表格-->
                        <table class="table table-condensed table-bordered table-striped text-center">
                            <caption class="text-right"><span lang="zh">金额单位：万元</span></caption>
                            <thead>
                            <tr>
                                <th class="text-center col-xs-1" lang="zh">订单编号</th>
                                <th class="text-center col-xs-1" lang="zh">商机编号</th>
                                <th class="text-center col-xs-1" lang="zh">客户名称</th>
                                <th class="text-center col-xs-1" lang="zh">客户类型</th>
                                <th class="text-center col-xs-1" lang="zh">企业性质</th>
                                <th class="text-center col-xs-1" lang="zh">订单总价</th>
                                <th class="text-center col-xs-4" lang="zh">订单产品</th>
                                <th class="text-center col-xs-1" lang="zh">状态</th>
                            </tr>
                            </thead>
                            <tbody id="offerList"></tbody>
                        </table>
                        <!--分页导航-->
                        <div id="pagination" class="pagination"></div>
                    </div>
                </div>
        </div>
    </div>
</div>

## 失败原因modal
<div class="modal fade" id="rModal" tabindex="-1" role="dialog" data-backdrop="false" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    ×
                </button>
            </div>
            <div class="modal-body">
                <form id="rForm" class="form-horizontal">
                    <div class="form-group">
                        <label for="reason" class="control-label col-xs-2">失败原因<sup class="not-null">*</sup></label>
                        <div class="col-xs-9">
                            <textarea class="form-control" id="reason" name="reason" rows="6"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <div class="row">
                    <div class="col-xs-2  col-xs-offset-9">
                        <button id="upReasons" data-form-btn="add" type="button" class="btn btn-block btn-primary" lang="zh">提交</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

## 报价列表
<script id="olC" type="text/html">
    <%if (data && data.length>0) {%>
    <%for (var i=0; i<data.length; i++) {
        var customerLevelList = ['战略客户','大客户' ,'重要客户' ,'一般客户' ,'风险客户'];
        var businessOpportunity = ['工厂','分销商' ,'经销商' ,'终端客户' ,'其他'];
        var businessStateList = ['报价失败','订单取消','报价中','已转化成订单','数据已上报到NC','已签约'];
    %>
    <tr>
<<<<<<< HEAD
        <td><a href="/businessOrder/intoOfferorOrder?orderId=<%=data[i].orderId%>"><%=data[i].orderId%></a></td>
        <td><a href="/businessOrder/intoBusinessOpportunityInfo?orderId=<%=data[i].businessId%>"><%=data[i].businessId%></a></td>
        <td><%=data[i].customerName%></td><td lang="zh"><%=customerLevelList[data[i].customerLevel - 1]%></td>
=======
        <td><a href="${request.contextPath}/businessOrder/intoOfferorOrder?orderId=<%=data[i].orderId%>"><%=data[i].orderId%></a></td>
        <td><a href="${request.contextPath}/businessOrder/intoBusinessOpportunityInfo?orderId=<%=data[i].businessId%>"><%=data[i].businessId%></a></td>
        <td><%=data[i].customerName%></td>
        <td lang="zh"><%=customerLevelList[data[i].customerLevel - 1]%></td>
>>>>>>> 0847fff2a404b58ce208804d1efb04b372a6c003
        <td lang="zh"><%=data[i].enterpriseNature%></td>
        <td><%=data[i].amountPayable%></td>
        <td><%=data[i].orderProduct%></td>
        <%if ((data[i].status+2)!=2) {%>
        <td lang="zh"><%=businessStateList[data[i].status + 2]%></td>
        <%} else{%>
        <td lang="zh">
            <a data-toggle="dropdown" class="dropdown" href="#"><%=businessStateList[data[i].status + 2]%></a>
            <ul class="dropdown-menu pull-right">
                <li><a href="${request.contextPath}/businessOrder/intoBusinessOfferConverse?orderId=<%=data[i].orderId%>">转化</a></li>
                <li><a data-val="<%=data[i].orderId%>" data-toggle="modal" href="#rModal">失败</a></li>
            </ul>
        </td>
        <%}%>
    </tr>
    <%}%>
    <%} else{%>
    <tr></tr>
    <%}%>
</script>

<script type="text/javascript" src="${request.contextPath}/lib/js/pagination/pagination.js"></script>
<script type="text/javascript" src="${request.contextPath}/lib/js/commons/commons.js"></script>
<link rel="stylesheet" type="text/css" href="${request.contextPath}/lib/js/pagination/pagination.css" />
<script type="text/javascript" language="javascript" src="${request.contextPath}/lib/js/creatTree.js"></script>

<script type="text/javascript">
    var pageSize = 3;
    var click_node ={oneLevelId:0,twoLevelId:0};//接收目录树点击节点的id及其父id
    click_node.serach = function(){
        serach();
    }

    $(document).ready(function(){

        //生成地区目录树
        $('#tree').creatTree('/customerBaseInfo/initAreaCategoryTree');

        //目录树节点绑定点击事件
        $('#tree').bindClickForCusArea(click_node);

        //搜索按钮绑定事件
        $("#submit").click(function(){
            serach();
        });

        //默认查询数据
        serach();

        // 弹出失败原因模态
        var thisOrder = '';
        $(document).on('click','a[href="#rModal"]',function (e) {
            // 取得当前订单号
            thisOrder = $(this).data('val');
            // 打开modal
            $('#rModal').modal('show');
        })

        // 提交失败原因
        $('#upReasons').on('click',function () {
            CRM.ajaxCall({
                url : '/businessOrder/updateOfferStatus',
                data : JSON.stringify(cltReaData(thisOrder,$('#reason').val())),
                type :'POST',
                contentType : "application/json",
                callback:function () {
                    $('#rModal').modal('hide');
                    alert('提交成功');
                    $('#reason').val('');
                    serach();
                }
            })
        });
    })

    // 流失原因需要上传的数据
    function cltReaData(num,con) {
        var obj = {
            orderId : num,
            failureAnalysis : con,
            status : -2
        }
        return obj;
    }

    //查询按钮提交数据
    function serach(){
        var total = getListCount();
        getDataList(0);
        $("#pagination").pagination(total,{
            items_per_page : pageSize,
            num_edge_entries : 3,
            num_display_entries : 10,
            callback:getDataList
        });
    }

    function getDataList(pageNum,jq){
        var data = {
            orderId:$('#orderId').val(),
            customerName:$('#customerName').val(),
            orderStatus:$('#businessState').val(),
            customerLevel:$('#customerLevel').val(),
            enterpriseNature:$('#enterpriseNature').val(),
            areaClassId:click_node.oneLevelId,
            areaId:click_node.twoLevelId,
            startRow:pageNum*pageSize,
            pageSize:pageSize
        };
        jQuery.ajax({
            url: basePath + '/businessOrder/getOfferListPageByQuery',
            dataType:'json',
            async:true,
            method:'POST',
            contentType:"application/json",
            data:JSON.stringify(data),
            success:function(data){
                var ResultData = data.data;
                // 前段模板渲染列表
                CRM.tplHandler('olC',ResultData,$('#offerList'));
            }
        });
    }

    /**
     * 获取列表数据总条目数
     */
    function getListCount(){
        var total = 0;
        var data = {
            areaClassId:click_node.oneLevelId,
            areaId:click_node.twoLevelId,
            orderId:$('#orderId').val(),
            customerName:$('#customerName').val(),
            orderStatus:$('#businessState').val(),
            customerLevel:$('#customerLevel').val(),
            enterpriseNature:$('#enterpriseNature').val()
        };
        jQuery.ajax({
            url:basePath + '/businessOrder/countOffer',
            dataType:'JSON',
            async:false,
            method:'POST',
            contentType:"application/json",
            data:JSON.stringify(data),
            success:function(data){
                console.log(data);
                total = data.data;
            }
        });
        return total;
    }
</script>